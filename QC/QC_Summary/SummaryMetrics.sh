####################################################################################################################
####################################################################################################################
# Get summary table for QC.
# Author: Haiying Kong
# Last Modified: 19 December 2021
####################################################################################################################
####################################################################################################################
#!/bin/bash -i

####################################################################################################################
####################################################################################################################
# Get batch name and number of thread from argument passing.
while getopts ":d:b:" opt
do
  case $opt in
    d) dir_name="$OPTARG";;
    b) batch="$OPTARG";;
    \?) echo "Invalid option -$OPTARG" >&2;;
  esac
done

####################################################################################################################
####################################################################################################################
# Check if argument inputs from command are correct.
if [ -z "${dir_name}" ]
then
  echo "Error: Directory name is empty"
  exit 1
fi

if [ -z "$batch" ]
then
  echo "Error: Batch name is empty"
  exit 1
fi

####################################################################################################################
####################################################################################################################
# Define directories to save log files and error files.
# log directory:
log_dir=/home/projects/cu_10184/projects/PTH/QC/log/SummTable/${batch}
rm -rf ${log_dir}
mkdir -p ${log_dir}

# error directory:
error_dir=/home/projects/cu_10184/projects/PTH/QC/error/SummTable/${batch}
rm -rf ${error_dir}
mkdir -p ${error_dir}

####################################################################################################################
####################################################################################################################
# Get BAM file names.
cd /home/projects/cu_10184/projects/PTH/BatchWork/${batch}/Lock/BAM
bam_files=($(ls *.bam))

####################################################################################################################
# Get sample names.
sams=($(echo ${bam_files[@]%.bam} | tr ' ' '\n' | sort -u | tr '\n' ' '))

####################################################################################################################
# Run pipeline on all samples in this batch.
####################################################################################################################
for sam in ${sams[@]}
do
  qsub -o ${log_dir}/${sam}.log -e ${error_dir}/${sam}.error -N ${batch}_${sam}_QC_Summary \
    -v dir_name=${dir_name},batch=${batch},sam=${sam} \
    /home/projects/cu_10184/projects/PTH/Code/QC/QC_Summary/SummaryMetrics_job.sh
done

####################################################################################################################
####################################################################################################################
